name: Build Windows Executable (Go)

on:
  workflow_dispatch:
  # push:
  #   paths:
  #     - '**.go'
  #     - 'go.mod'
  #     - 'lib/**'
  #     - 'android/**' # 确保 android 目录下的文件变更也能触发

jobs:
  build-windows-go:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22' # 使用较新的 Go 版本
          cache: true        # 自动开启依赖缓存

      - name: Install dependencies
        run: |
          go mod tidy
          # 如果有其他特定工具可以在这里安装

      - name: Build Windows Executable
        run: |
          # 设置环境变量以确保构建目标为 Windows amd64
          $Env:GOOS = "windows"
          $Env:GOARCH = "amd64"
          
          # 编译 main.go，输出为 ProbeWebTool.exe
          # -ldflags "-s -w" 用于减小二进制体积（去除调试符号）
          go build -ldflags "-s -w" -o ProbeWebTool.exe main.go

      - name: Prepare Distribution Directory
        run: |
          # 创建 dist 目录
          New-Item -ItemType Directory -Force -Path dist
          
          # 将 exe 移动到 dist
          Move-Item -Path ProbeWebTool.exe -Destination dist/
          
          # 将 static 文件夹复制到 dist (因为 Go 代码中是读取 ./static 目录)
          Copy-Item -Path static -Destination dist/ -Recurse

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ProbeWebTool-Windows-Bundle
          path: dist/ # 上传整个 dist 目录，确保 exe 能找到 static 文件夹
          # retention-days: 7
