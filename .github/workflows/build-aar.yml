# .github/workflows/build-aar.yml
name: Build Go Android AAR

on:
  workflow_dispatch:
  # push:
  #   paths:
  #     - '**.go'
  #     - 'go.mod'
  #     - 'lib/**'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25' # 保持与 go.mod 中声明的 Go 版本一致

      - name: Setup Android SDK & NDK
        run: |
          # 确保 ANDROID_HOME 在当前 shell 会话中可用，并导出到环境中
          echo "ANDROID_HOME=/usr/local/lib/android/sdk" >> $GITHUB_ENV
          export ANDROID_HOME=/usr/local/lib/android/sdk
          
          # 将 Android SDK 命令行工具添加到 PATH，并在环境变量中持久化
          echo "$ANDROID_HOME/cmdline-tools/latest/bin" >> $GITHUB_PATH
          export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin
          
          # 安装指定版本的 NDK
          yes | sdkmanager "ndk;25.2.9519653"
          
          # 设置 ANDROID_NDK_HOME 环境变量供 gomobile 使用，并在环境中持久化
          echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/25.2.9519653" >> $GITHUB_ENV
          export ANDROID_NDK_HOME=$ANDROID_HOME/ndk/25.2.9519653

      - name: Install gomobile tools
        run: |
          go install golang.org/x/mobile/cmd/gomobile@latest
          go install golang.org/x/mobile/cmd/gobind@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH # 添加到 PATH

      - name: Configure Go Module (if not exists) and Download Dependencies
        run: |
          if [ ! -f go.mod ]; then
            go mod init probetool 
          fi
          # go mod tidy 会自动下载所有依赖
          go mod tidy
          # 从参考文件中采纳的关键行：下载 gomobile bind 所需的依赖
          go get golang.org/x/mobile/bind
        env:
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}

      - name: Initialize gomobile
        run: gomobile init
        env:
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}

      - name: Build AAR
        run: |
          # 最终的 gomobile bind 命令
          # -target=android -androidapi 24: 目标平台和API级别
          # -javapkg "com.xiaofei.probetool": 指定生成的Java/Kotlin包名
          # -o probetool.aar: 指定输出文件名为 probetool.aar
          # probetool/server: 绑定 probetool 模块下的 server 包，该包包含 JNI 导出的函数
          gomobile bind -target=android -androidapi 24 -o probetool.aar -javapkg "com.xiaofei.probetool" probetool/server
        env:
          ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}

      - name: Upload AAR Artifact
        uses: actions/upload-artifact@v4
        with:
          name: probetool-aar
          path: probetool.aar
